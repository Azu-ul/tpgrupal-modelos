<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Rest√≥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .header {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vista {
            background: white;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }

        .vista.active {
            display: block;
        }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.success {
            background: #28a745;
        }

        button.danger {
            background: #dc3545;
        }

        input,
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
        }

        .form-group {
            margin: 15px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .mesa-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #ddd;
        }

        .mesa-card.ocupada {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .mesa-card.mia {
            border-color: #28a745;
            background: #d4edda;
        }

        .pedido-card {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .estado {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .estado.pendiente {
            background: #ffc107;
            color: #000;
        }

        .estado.en_preparacion {
            background: #17a2b8;
            color: white;
        }

        .estado.listo {
            background: #28a745;
            color: white;
        }

        .estado.entregado {
            background: #6c757d;
            color: white;
        }

        .estado.pagado {
            background: #343a40;
            color: white;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
        }

        h3 {
            margin: 15px 0;
            color: #555;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üçΩÔ∏è Sistema Rest√≥</h1>
        <div>
            <select id="rolSelector" onchange="cambiarVista()">
                <option value="">Seleccionar rol...</option>
            </select>
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="vistaAdmin" class="vista">
        <h2>Panel de Administraci√≥n</h2>

        <h3>Registrar Personal</h3>
        <div class="form-group">
            <input type="text" id="nombrePersonal" placeholder="Nombre">
            <select id="rolPersonal">
                <option value="mozo">Mozo</option>
                <option value="chef">Chef</option>
                <option value="cocinero">Cocinero</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="agregarPersonal()">Agregar Personal</button>
        </div>
        <table id="tablaPersonal">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Registrar Mesa</h3>
        <div class="form-group">
            <input type="number" id="numeroMesa" placeholder="N√∫mero">
            <input type="number" id="capacidadMesa" placeholder="Capacidad">
            <button onclick="agregarMesa()">Agregar Mesa</button>
        </div>
        <table id="tablaMesas">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Capacidad</th>
                    <th>Mozo Asignado</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h3>Registrar Item de Men√∫</h3>
        <div class="form-group">
            <input type="text" id="nombreMenu" placeholder="Nombre">
            <input type="number" id="precioMenu" placeholder="Precio">
            <select id="categoriaMenu">
                <option value="entrada">Entrada</option>
                <option value="principal">Principal</option>
                <option value="postre">Postre</option>
                <option value="bebida">Bebida</option>
            </select>
            <button onclick="agregarMenu()">Agregar al Men√∫</button>
        </div>
        <table id="tablaMenu">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Categor√≠a</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Reportes</h3>
        <div class="form-group">
            <label>Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            <label>Fecha Fin:</label>
            <input type="date" id="fechaFin">
            <button onclick="generarReporte()">Generar Reporte</button>
        </div>
        <div id="reporteResultado"></div>
    </div>

    <!-- VISTA MOZO -->
    <div id="vistaMozo" class="vista">
        <h2>Panel de Mozo - <span id="nombreMozo"></span></h2>

        <h3>Mesas Disponibles</h3>
        <div class="grid" id="mesasDisponibles"></div>

        <h3>Mis Mesas</h3>
        <div id="misMesas"></div>
    </div>

    <!-- VISTA CHEF -->
    <div id="vistaChef" class="vista">
        <h2>Panel de Chef</h2>
        <div id="ordenesChef"></div>
    </div>

    <!-- VISTA GENERAL -->
    <div id="vistaGeneral" class="vista">
        <h2>Vista General - Todas las Mesas y √ìrdenes</h2>
        <div class="grid" id="todasMesas"></div>
        <h3>Todas las √ìrdenes</h3>
        <div id="todasOrdenes"></div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let personal = [];
        let mesas = [];
        let menu = [];
        let pedidos = [];
        let usuarioActual = null;

        async function cargarDatos() {
            personal = await fetch(`${API}/personal`).then(r => r.json());
            mesas = await fetch(`${API}/mesas`).then(r => r.json());
            menu = await fetch(`${API}/menu`).then(r => r.json());
            pedidos = await fetch(`${API}/pedidos`).then(r => r.json());

            const sel = document.getElementById('rolSelector');
            sel.innerHTML = '<option value="">Seleccionar rol...</option>';
            sel.innerHTML += '<option value="admin-1">Admin Principal</option>';
            personal.filter(p => p.rol === 'mozo').forEach(p => {
                sel.innerHTML += `<option value="mozo-${p.id}">${p.nombre} (Mozo)</option>`;
            });
            sel.innerHTML += '<option value="chef-1">Chef</option>';
            sel.innerHTML += '<option value="general">Vista General</option>';
        }

        function cambiarVista() {
            const sel = document.getElementById('rolSelector').value;
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));

            if (sel.startsWith('admin')) {
                document.getElementById('vistaAdmin').classList.add('active');
                cargarAdmin();
            } else if (sel.startsWith('mozo')) {
                const id = sel.split('-')[1];
                usuarioActual = personal.find(p => p.id == id);
                document.getElementById('vistaMozo').classList.add('active');
                document.getElementById('nombreMozo').textContent = usuarioActual.nombre;
                cargarMozo();
            } else if (sel.startsWith('chef')) {
                document.getElementById('vistaChef').classList.add('active');
                cargarChef();
            } else if (sel === 'general') {
                document.getElementById('vistaGeneral').classList.add('active');
                cargarGeneral();
            }
        }

        async function cargarAdmin() {
            const tbPersonal = document.querySelector('#tablaPersonal tbody');
            tbPersonal.innerHTML = personal.map(p =>
                `<tr><td>${p.id}</td><td>${p.nombre}</td><td>${p.rol}</td></tr>`
            ).join('');

            const tbMenu = document.querySelector('#tablaMenu tbody');
            tbMenu.innerHTML = menu.map(m =>
                `<tr><td>${m.nombre}</td><td>$${m.precio}</td><td>${m.categoria}</td></tr>`
            ).join('');

            const tbMesas = document.querySelector('#tablaMesas tbody');
            tbMesas.innerHTML = mesas.map(m =>
                `<tr><td>${m.numero}</td><td>${m.capacidad}</td><td>${m.mozo_nombre || 'Disponible'}</td></tr>`
            ).join('');
        }

        async function agregarPersonal() {
            const nombre = document.getElementById('nombrePersonal').value;
            const rol = document.getElementById('rolPersonal').value;
            await fetch(`${API}/personal`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, rol })
            });
            document.getElementById('nombrePersonal').value = '';
            await cargarDatos();
            cargarAdmin();
        }

        async function agregarMesa() {
            const numero = document.getElementById('numeroMesa').value;
            const capacidad = document.getElementById('capacidadMesa').value;
            const res = await fetch(`${API}/mesas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero, capacidad })
            });
            if (!res.ok) {
                alert('Error: Mesa duplicada o problema en BD');
                return;
            }
            document.getElementById('numeroMesa').value = '';
            document.getElementById('capacidadMesa').value = '';
            await cargarDatos();
        }

        async function agregarMenu() {
            const nombre = document.getElementById('nombreMenu').value;
            const precio = document.getElementById('precioMenu').value;
            const categoria = document.getElementById('categoriaMenu').value;
            await fetch(`${API}/menu`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, precio, categoria })
            });
            document.getElementById('nombreMenu').value = '';
            document.getElementById('precioMenu').value = '';
            await cargarDatos();
            cargarAdmin();
        }

        async function generarReporte() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            const topMenu = await fetch(`${API}/reportes/top-menu?fecha_inicio=${inicio}&fecha_fin=${fin}`).then(r => r.json());
            const ventas = await fetch(`${API}/reportes/ventas?fecha_inicio=${inicio}&fecha_fin=${fin}`).then(r => r.json());

            let html = '<h3>Top 5 Men√∫s M√°s Vendidos</h3><table><thead><tr><th>Nombre</th><th>Categor√≠a</th><th>Cantidad</th><th>Ingresos</th></tr></thead><tbody>';
            topMenu.forEach(m => {
                html += `<tr><td>${m.nombre}</td><td>${m.categoria}</td><td>${m.total_vendido}</td><td>$${m.ingresos}</td></tr>`;
            });
            html += `</tbody></table><h3>Resumen de Ventas</h3><p>Total Pedidos: ${ventas.total_pedidos || 0}</p><p>Total Ingresos: $${ventas.total_ventas || 0}</p>`;

            document.getElementById('reporteResultado').innerHTML = html;
        }

        async function cargarMozo() {
            await cargarDatos();

            const disponibles = mesas.filter(m => !m.mozo_id);
            const misMesas = mesas.filter(m => m.mozo_id == usuarioActual.id);

            document.getElementById('mesasDisponibles').innerHTML = disponibles.map(m => `
                <div class="mesa-card">
                    <div><strong>Mesa ${m.numero}</strong></div>
                    <div>Capacidad: ${m.capacidad}</div>
                    <button onclick="tomarMesa(${m.id})">Tomar Mesa</button>
                </div>
            `).join('');

            let html = '';
            for (let mesa of misMesas) {
                const pedidosMesa = pedidos.filter(p => p.mesa_id === mesa.id && p.estado !== 'pagado');
                html += `<div class="mesa-card mia">
                    <h4>Mesa ${mesa.numero}</h4>
                    ${pedidosMesa.map(p => `
                        <div class="pedido-card">
                            <span class="estado ${p.estado}">${p.estado}</span> - $${p.total}
                            ${p.estado === 'entregado' ? `<button class="success" onclick="cobrarPedido(${p.id})">Cobrar</button>` : ''}
                        </div>
                    `).join('')}
                    <button onclick="crearPedido(${mesa.id})">Nuevo Pedido</button>
                    <button class="secondary" onclick="liberarMesa(${mesa.id})">Liberar Mesa</button>
                </div>`;
            }
            document.getElementById('misMesas').innerHTML = html || '<p>No tienes mesas asignadas</p>';
        }

        async function tomarMesa(mesaId) {
            await fetch(`${API}/mesas/${mesaId}/asignar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mozo_id: usuarioActual.id })
            });
            cargarMozo();
        }

        async function liberarMesa(mesaId) {
            await fetch(`${API}/mesas/${mesaId}/asignar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mozo_id: null })
            });
            cargarMozo();
        }

        function crearPedido(mesaId) {
            const items = [];
            menu.forEach(m => {
                const cant = prompt(`${m.nombre} ($${m.precio}) - Cantidad:`);
                if (cant && cant > 0) {
                    items.push({ menu_id: m.id, cantidad: parseInt(cant), precio: parseFloat(m.precio) });
                }
            });

            if (items.length > 0) {
                fetch(`${API}/pedidos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mesa_id: mesaId, mozo_id: usuarioActual.id, items })
                }).then(() => cargarMozo());
            }
        }

        async function cobrarPedido(pedidoId) {
            await fetch(`${API}/pedidos/${pedidoId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: 'pagado' })
            });
            cargarMozo();
        }

        async function cargarChef() {
            await cargarDatos();
            const pendientes = pedidos.filter(p => ['pendiente', 'en_preparacion', 'listo'].includes(p.estado));

            let html = '';
            for (let p of pendientes) {
                const items = await fetch(`${API}/pedidos/${p.id}/items`).then(r => r.json());
                html += `<div class="pedido-card">
                    <strong>Pedido #${p.id} - Mesa ${p.mesa_numero}</strong>
                    <span class="estado ${p.estado}">${p.estado}</span>
                    <div>${items.map(i => `${i.nombre} x${i.cantidad}`).join(', ')}</div>
                    <div>
                        ${p.estado === 'pendiente' ? `<button onclick="cambiarEstado(${p.id}, 'en_preparacion')">Iniciar</button>` : ''}
                        ${p.estado === 'en_preparacion' ? `<button class="success" onclick="cambiarEstado(${p.id}, 'listo')">Listo</button>` : ''}
                        ${p.estado === 'listo' ? `<button class="secondary" onclick="cambiarEstado(${p.id}, 'entregado')">Despachar</button>` : ''}
                    </div>
                </div>`;
            }
            document.getElementById('ordenesChef').innerHTML = html || '<p>No hay √≥rdenes pendientes</p>';
        }

        async function cambiarEstado(pedidoId, estado) {
            await fetch(`${API}/pedidos/${pedidoId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado })
            });
            cargarChef();
        }

        async function cargarGeneral() {
            await cargarDatos();

            document.getElementById('todasMesas').innerHTML = mesas.map(m => {
                const ocupada = m.mozo_id ? 'ocupada' : '';
                return `<div class="mesa-card ${ocupada}">
                    <div><strong>Mesa ${m.numero}</strong></div>
                    <div>Cap: ${m.capacidad}</div>
                    ${m.mozo_nombre ? `<div>Mozo: ${m.mozo_nombre}</div>` : '<div>Disponible</div>'}
                </div>`;
            }).join('');

            let html = '';
            for (let p of pedidos.filter(p => p.estado !== 'pagado')) {
                const items = await fetch(`${API}/pedidos/${p.id}/items`).then(r => r.json());
                html += `<div class="pedido-card">
                    <strong>Pedido #${p.id} - Mesa ${p.mesa_numero} - ${p.mozo_nombre}</strong>
                    <span class="estado ${p.estado}">${p.estado}</span>
                    <div>${items.map(i => `${i.nombre} x${i.cantidad}`).join(', ')}</div>
                    <div>Total: $${p.total}</div>
                </div>`;
            }
            document.getElementById('todasOrdenes').innerHTML = html || '<p>No hay √≥rdenes activas</p>';
        }

        cargarDatos();
    </script>
</body>

</html>