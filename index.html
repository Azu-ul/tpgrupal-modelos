<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Rest√≥</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="header">
        <h1>üçΩÔ∏è Sistema Rest√≥</h1>
        <div>
            <select id="rolSelector" onchange="cambiarVista()">
                <option value="">Seleccionar rol...</option>
            </select>
        </div>
    </div>

    <!-- VISTA ADMIN -->
    <div id="vistaAdmin" class="vista">
        <h2>Panel de Administraci√≥n</h2>

        <h3>Registrar Personal</h3>
        <div class="form-group">
            <input type="text" id="nombrePersonal" placeholder="Nombre">
            <select id="rolPersonal">
                <option value="mozo">Mozo</option>
                <option value="chef">Chef</option>
                <option value="cocinero">Cocinero</option>
                <option value="admin">Admin</option>
            </select>
            <button onclick="agregarPersonal()">Agregar Personal</button>
        </div>
        <table id="tablaPersonal">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                </tr>
            </thead>
            <tbody id="tbodyPersonal"></tbody>
        </table>

        <h3>Registrar Mesa</h3>
        <div class="form-group">
            <input type="number" id="numeroMesa" placeholder="N√∫mero">
            <input type="number" id="capacidadMesa" placeholder="Capacidad">
            <button onclick="agregarMesa()">Agregar Mesa</button>
        </div>
        <table id="tablaMesas">
            <thead>
                <tr>
                    <th>N√∫mero</th>
                    <th>Capacidad</th>
                    <th>Mozo Asignado</th>
                </tr>
            </thead>
            <tbody id="tbodyMesas"></tbody>
        </table>
        <h3>Registrar Item de Men√∫</h3>
        <div class="form-group">
            <input type="text" id="nombreMenu" placeholder="Nombre">
            <input type="number" id="precioMenu" placeholder="Precio">
            <select id="categoriaMenu">
                <option value="entrada">Entrada</option>
                <option value="principal">Principal</option>
                <option value="postre">Postre</option>
                <option value="bebida">Bebida</option>
            </select>
            <button onclick="agregarMenu()">Agregar al Men√∫</button>
        </div>
        <table id="tablaMenu">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Categor√≠a</th>
                </tr>
            </thead>
            <tbody id="tbodyMenu"></tbody>
        </table>

        <h3>Reportes</h3>
        <div class="form-group">
            <label>Fecha Inicio:</label>
            <input type="date" id="fechaInicio">
            <label>Fecha Fin:</label>
            <input type="date" id="fechaFin">
            <button onclick="generarReporte()">Generar Reporte</button>
        </div>
        <div id="reporteResultado"></div>
    </div>

    <!-- VISTA COCINERO -->
    <div id="vistaCocinero" class="vista">
        <h2>Panel de Cocinero - <span id="nombreCocinero"></span></h2>
        <div id="pedidosCocinero"></div>
    </div>

    <!-- VISTA MOZO -->
    <div id="vistaMozo" class="vista">
        <h2>Panel de Mozo - <span id="nombreMozo"></span></h2>

        <h3>Mesas Disponibles</h3>
        <div class="grid" id="mesasDisponibles"></div>

        <h3>Mis Mesas</h3>
        <div id="misMesas"></div>
    </div>

    <!-- VISTA CHEF -->
    <div id="vistaChef" class="vista">
        <h2>Panel de Chef</h2>
        <div id="ordenesChef"></div>
    </div>

    <!-- VISTA GENERAL -->
    <div id="vistaGeneral" class="vista">
        <h2>Vista General - Todas las Mesas y √ìrdenes</h2>
        <div class="grid" id="todasMesas"></div>
        <h3>Todas las √ìrdenes</h3>
        <div id="todasOrdenes"></div>
    </div>

    <!-- MODAL PEDIDO -->
    <div id="modalPedido" class="modal">
        <div class="modal-content">
            <h3>Nuevo Pedido - Mesa <span id="mesaPedido"></span></h3>
            <div id="menuItems"></div>
            <div style="margin-top: 20px; text-align: right;">
                <button class="secondary" onclick="cerrarModal()">Cancelar</button>
                <button class="success" onclick="guardarPedido()">Guardar Pedido</button>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:3000/api';
        let personal = [];
        let mesas = [];
        let menu = [];
        let pedidos = [];
        let usuarioActual = null;

        async function cargarDatos() {
            personal = await fetch(`${API}/personal`).then(r => r.json());
            mesas = await fetch(`${API}/mesas`).then(r => r.json());
            menu = await fetch(`${API}/menu`).then(r => r.json());
            pedidos = await fetch(`${API}/pedidos`).then(r => r.json());

            const sel = document.getElementById('rolSelector');
            sel.innerHTML = '<option value="">Seleccionar rol...</option>';
            sel.innerHTML += '<option value="admin-1">Admin Principal</option>';
            personal.filter(p => p.rol === 'mozo').forEach(p => {
                sel.innerHTML += `<option value="mozo-${p.id}">${p.nombre} (Mozo)</option>`;
            });
            personal.filter(p => p.rol === 'cocinero').forEach(p => {
                sel.innerHTML += `<option value="cocinero-${p.id}">${p.nombre} (Cocinero)</option>`;
            });
            sel.innerHTML += '<option value="chef-1">Chef</option>';
            sel.innerHTML += '<option value="general">Vista General</option>';
        }

        function cambiarVista() {
            const sel = document.getElementById('rolSelector').value;
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));

            if (sel.startsWith('admin')) {
                document.getElementById('vistaAdmin').classList.add('active');
                cargarAdmin();
            } else if (sel.startsWith('mozo')) {
                const id = sel.split('-')[1];
                usuarioActual = personal.find(p => p.id == id);
                document.getElementById('vistaMozo').classList.add('active');
                document.getElementById('nombreMozo').textContent = usuarioActual.nombre;
                cargarMozo();
            } else if (sel.startsWith('cocinero')) {
                const id = sel.split('-')[1];
                usuarioActual = personal.find(p => p.id == id);
                document.getElementById('vistaCocinero').classList.add('active');
                document.getElementById('nombreCocinero').textContent = usuarioActual.nombre;
                cargarCocinero();
            } else if (sel.startsWith('chef')) {
                document.getElementById('vistaChef').classList.add('active');
                cargarChef();
            } else if (sel === 'general') {
                document.getElementById('vistaGeneral').classList.add('active');
                cargarGeneral();
            }
        }

        async function cargarAdmin() {
            const tbPersonal = document.getElementById('tbodyPersonal');
            tbPersonal.innerHTML = personal.map(p => `
        <tr>
            <td>${p.id}</td>
            <td><input type="text" id="pnombre-${p.id}" value="${p.nombre}" style="width:150px"></td>
            <td>
                <select id="prol-${p.id}">
                    <option ${p.rol === 'mozo' ? 'selected' : ''}>mozo</option>
                    <option ${p.rol === 'chef' ? 'selected' : ''}>chef</option>
                    <option ${p.rol === 'cocinero' ? 'selected' : ''}>cocinero</option>
                    <option ${p.rol === 'admin' ? 'selected' : ''}>admin</option>
                </select>
            </td>
            <td>
                <button onclick="editarPersonal(${p.id})">üíæ</button>
                <button class="danger" onclick="eliminarPersonal(${p.id})">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');

            const tbMenu = document.getElementById('tbodyMenu');
            tbMenu.innerHTML = menu.map(m => `
        <tr>
            <td><input type="text" id="mnombre-${m.id}" value="${m.nombre}" style="width:150px"></td>
            <td><input type="number" id="mprecio-${m.id}" value="${m.precio}" style="width:80px"></td>
            <td>
                <select id="mcat-${m.id}">
                    <option ${m.categoria === 'entrada' ? 'selected' : ''}>entrada</option>
                    <option ${m.categoria === 'principal' ? 'selected' : ''}>principal</option>
                    <option ${m.categoria === 'postre' ? 'selected' : ''}>postre</option>
                    <option ${m.categoria === 'bebida' ? 'selected' : ''}>bebida</option>
                </select>
            </td>
            <td>
                <button onclick="editarMenu(${m.id})">üíæ</button>
                <button class="danger" onclick="eliminarMenu(${m.id})">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');

            const tbMesas = document.getElementById('tbodyMesas');
            tbMesas.innerHTML = mesas.map(m => `
        <tr>
            <td><input type="number" id="mnum-${m.id}" value="${m.numero}" style="width:60px"></td>
            <td><input type="number" id="mcap-${m.id}" value="${m.capacidad}" style="width:60px"></td>
            <td>${m.mozo_nombre || 'Disponible'}</td>
            <td>
                <button onclick="editarMesa(${m.id})">üíæ</button>
                <button class="danger" onclick="eliminarMesa(${m.id})">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');
        }

        async function editarPersonal(id) {
            const nombre = document.getElementById(`pnombre-${id}`).value;
            const rol = document.getElementById(`prol-${id}`).value;
            await fetch(`${API}/personal/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, rol })
            });
            await cargarDatos();
            cargarAdmin();
        }

        async function eliminarPersonal(id) {
            if (!confirm('¬øEliminar este personal?')) return;
            const res = await fetch(`${API}/personal/${id}`, { method: 'DELETE' });
            if (!res.ok) alert('No se puede eliminar, tiene relaciones activas');
            await cargarDatos();
            cargarAdmin();
        }

        async function editarMesa(id) {
            const numero = document.getElementById(`mnum-${id}`).value;
            const capacidad = document.getElementById(`mcap-${id}`).value;
            const res = await fetch(`${API}/mesas/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero, capacidad })
            });
            if (!res.ok) alert('N√∫mero de mesa duplicado');
            await cargarDatos();
            cargarAdmin();
        }

        async function eliminarMesa(id) {
            if (!confirm('¬øEliminar esta mesa?')) return;
            const res = await fetch(`${API}/mesas/${id}`, { method: 'DELETE' });
            if (!res.ok) alert('No se puede eliminar, tiene pedidos asociados');
            await cargarDatos();
            cargarAdmin();
        }

        async function editarMenu(id) {
            const nombre = document.getElementById(`mnombre-${id}`).value;
            const precio = document.getElementById(`mprecio-${id}`).value;
            const categoria = document.getElementById(`mcat-${id}`).value;
            await fetch(`${API}/menu/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, precio, categoria })
            });
            await cargarDatos();
            cargarAdmin();
        }

        async function eliminarMenu(id) {
            if (!confirm('¬øEliminar este √≠tem?')) return;
            const res = await fetch(`${API}/menu/${id}`, { method: 'DELETE' });
            if (!res.ok) alert('No se puede eliminar, est√° en pedidos activos');
            await cargarDatos();
            cargarAdmin();
        }

        async function agregarPersonal() {
            const nombre = document.getElementById('nombrePersonal').value;
            const rol = document.getElementById('rolPersonal').value;
            await fetch(`${API}/personal`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, rol })
            });
            document.getElementById('nombrePersonal').value = '';
            await cargarDatos();
            cargarAdmin();
        }

        async function agregarMesa() {
            const numero = document.getElementById('numeroMesa').value;
            const capacidad = document.getElementById('capacidadMesa').value;
            const res = await fetch(`${API}/mesas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ numero, capacidad })
            });
            if (!res.ok) {
                alert('Error: Mesa duplicada o problema en BD');
                return;
            }
            document.getElementById('numeroMesa').value = '';
            document.getElementById('capacidadMesa').value = '';
            await cargarDatos();
        }

        async function agregarMenu() {
            const nombre = document.getElementById('nombreMenu').value;
            const precio = document.getElementById('precioMenu').value;
            const categoria = document.getElementById('categoriaMenu').value;
            await fetch(`${API}/menu`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nombre, precio, categoria })
            });
            document.getElementById('nombreMenu').value = '';
            document.getElementById('precioMenu').value = '';
            await cargarDatos();
            cargarAdmin();
        }

        async function generarReporte() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;

            const topMenu = await fetch(`${API}/reportes/top-menu?fecha_inicio=${inicio}&fecha_fin=${fin}`).then(r => r.json());
            const ventas = await fetch(`${API}/reportes/ventas?fecha_inicio=${inicio}&fecha_fin=${fin}`).then(r => r.json());

            let html = '<h3>Top 5 Men√∫s M√°s Vendidos</h3><table><thead><tr><th>Nombre</th><th>Categor√≠a</th><th>Cantidad</th><th>Ingresos</th></tr></thead><tbody>';
            topMenu.forEach(m => {
                html += `<tr><td>${m.nombre}</td><td>${m.categoria}</td><td>${m.total_vendido}</td><td>$${m.ingresos}</td></tr>`;
            });
            html += `</tbody></table><h3>Resumen de Ventas</h3><p>Total Pedidos: ${ventas.total_pedidos || 0}</p><p>Total Ingresos: $${ventas.total_ventas || 0}</p>`;

            document.getElementById('reporteResultado').innerHTML = html;
        }

        async function cargarMozo() {
            await cargarDatos();

            const disponibles = mesas.filter(m => !m.mozo_id);
            const misMesas = mesas.filter(m => m.mozo_id == usuarioActual.id);

            document.getElementById('mesasDisponibles').innerHTML = disponibles.map(m => `
                <div class="mesa-card">
                    <div><strong>Mesa ${m.numero}</strong></div>
                    <div>Capacidad: ${m.capacidad}</div>
                    <button onclick="tomarMesa(${m.id})">Tomar Mesa</button>
                </div>
            `).join('');

            let html = '';
            for (let mesa of misMesas) {
                const pedidosMesa = pedidos.filter(p => p.mesa_id === mesa.id && p.estado !== 'pagado');
                html += `<div class="mesa-card mia">
                    <h4>Mesa ${mesa.numero}</h4>
                    ${pedidosMesa.map(p => `
                        <div class="pedido-card">
                            <span class="estado ${p.estado}">${p.estado}</span> - $${p.total}
                            ${p.estado === 'entregado' ? `<button class="success" onclick="cobrarPedido(${p.id})">Cobrar</button>` : ''}
                        </div>
                    `).join('')}
                    <button onclick="crearPedido(${mesa.id})">Nuevo Pedido</button>
                    <button class="secondary" onclick="liberarMesa(${mesa.id})">Liberar Mesa</button>
                </div>`;
            }
            document.getElementById('misMesas').innerHTML = html || '<p>No tienes mesas asignadas</p>';
        }

        async function tomarMesa(mesaId) {
            await fetch(`${API}/mesas/${mesaId}/asignar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mozo_id: usuarioActual.id })
            });
            cargarMozo();
        }

        async function liberarMesa(mesaId) {
            await fetch(`${API}/mesas/${mesaId}/asignar`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mozo_id: null })
            });
            cargarMozo();
        }

        let mesaActualPedido = null;

        function crearPedido(mesaId) {
            mesaActualPedido = mesaId;
            const mesa = mesas.find(m => m.id === mesaId);
            document.getElementById('mesaPedido').textContent = mesa.numero;

            const menuHtml = menu.map(m => `
                <div class="menu-item">
                    <label style="flex: 1; cursor: pointer;">
                        <input type="checkbox" class="item-check" data-id="${m.id}" data-precio="${m.precio}">
                        <strong>${m.nombre}</strong> - $${m.precio} <em>(${m.categoria})</em>
                    </label>
                    <input type="number" class="item-cant" data-id="${m.id}" value="1" min="1" disabled>
                </div>
            `).join('');

            document.getElementById('menuItems').innerHTML = menuHtml;

            document.querySelectorAll('.item-check').forEach(check => {
                check.addEventListener('change', function () {
                    const cantInput = document.querySelector(`.item-cant[data-id="${this.dataset.id}"]`);
                    cantInput.disabled = !this.checked;
                    if (this.checked) cantInput.focus();
                });
            });

            document.getElementById('modalPedido').classList.add('active');
        }

        function cerrarModal() {
            document.getElementById('modalPedido').classList.remove('active');
            mesaActualPedido = null;
        }

        async function guardarPedido() {
            const items = [];
            document.querySelectorAll('.item-check:checked').forEach(check => {
                const id = check.dataset.id;
                const cant = document.querySelector(`.item-cant[data-id="${id}"]`).value;
                items.push({
                    menu_id: parseInt(id),
                    cantidad: parseInt(cant),
                    precio: parseFloat(check.dataset.precio)
                });
            });

            if (items.length === 0) {
                alert('Selecciona al menos un item');
                return;
            }
            const chefId = usuarioActual.rol === 'chef' ? usuarioActual.id : null;
            await fetch(`${API}/pedidos`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mesa_id: mesaActualPedido, mozo_id: usuarioActual.id, items, chef_id: chefId })
            });

            cerrarModal();
            cargarMozo();
        }

        async function cobrarPedido(pedidoId) {
            await fetch(`${API}/pedidos/${pedidoId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: 'pagado' })
            });
            cargarMozo();
        }

        async function cargarChef() {
            await cargarDatos();
            const pendientes = pedidos.filter(p => ['pendiente', 'asignado', 'cocinando', 'en_preparacion', 'listo'].includes(p.estado));

            const cocineros = personal.filter(p => p.rol === 'cocinero');
            let html = '';
            for (let p of pendientes) {
                const items = await fetch(`${API}/pedidos/${p.id}/items`).then(r => r.json());
                html += `<div class="pedido-card">
            <strong>Pedido #${p.id} - Mesa ${p.mesa_numero}</strong>
            <span class="estado ${p.estado}">${p.estado}</span>
            ${p.cocinero_nombre ? `<div>üë®‚Äçüç≥ ${p.cocinero_nombre}</div>` : ''}
            <div>${items.map(i => `${i.nombre} x${i.cantidad}`).join(', ')}</div>
            <div>
                ${p.estado === 'pendiente' ? `
                    <select id="coci-${p.id}">
                        <option value="">Asignar cocinero...</option>
                        ${cocineros.map(c => `<option value="${c.id}">${c.nombre}</option>`).join('')}
                    </select>
                    <button onclick="asignarCocinero(${p.id})">Asignar</button>
                ` : ''}
                ${p.estado === 'cocinando' ? `<button onclick="cambiarEstado(${p.id}, 'en_preparacion')">Iniciar Preparaci√≥n Final</button>` : ''}
                ${p.estado === 'en_preparacion' ? `<button class="success" onclick="cambiarEstado(${p.id}, 'listo')">Listo</button>` : ''}
                ${p.estado === 'listo' ? `<button class="secondary" onclick="cambiarEstado(${p.id}, 'entregado')">Despachar</button>` : ''}
            </div>
        </div>`;
            }
            document.getElementById('ordenesChef').innerHTML = html || '<p>No hay √≥rdenes pendientes</p>';
        }

        async function asignarCocinero(pedidoId) {
            const cocineroId = document.getElementById(`coci-${pedidoId}`).value;
            if (!cocineroId) return alert('Selecciona un cocinero');
            await fetch(`${API}/pedidos/${pedidoId}/asignar-cocinero`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cocinero_id: cocineroId })
            });
            cargarChef();
        }

        async function cargarCocinero() {
            await cargarDatos();
            const misPedidos = pedidos.filter(p => p.cocinero_id == usuarioActual.id && ['asignado', 'cocinando'].includes(p.estado));

            let html = '';
            for (let p of misPedidos) {
                const items = await fetch(`${API}/pedidos/${p.id}/items`).then(r => r.json());
                html += `<div class="pedido-card">
            <strong>Pedido #${p.id} - Mesa ${p.mesa_numero}</strong>
            <span class="estado ${p.estado}">${p.estado}</span>
            <div>üë®‚Äçüç≥ Asignado por: ${p.chef_nombre}</div>
            <div>${items.map(i => `${i.nombre} x${i.cantidad}`).join(', ')}</div>
            <div>
                ${p.estado === 'asignado' ? `<button onclick="cambiarEstadoCocinero(${p.id}, 'cocinando')">üî• Cocinar</button>` : ''}
                ${p.estado === 'cocinando' ? `<button class="success" onclick="cambiarEstadoCocinero(${p.id}, 'en_preparacion')">‚úÖ Terminado</button>` : ''}
            </div>
        </div>`;
            }
            document.getElementById('pedidosCocinero').innerHTML = html || '<p>No tienes pedidos asignados</p>';
        }

        async function cambiarEstadoCocinero(pedidoId, estado) {
            await fetch(`${API}/pedidos/${pedidoId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado })
            });
            cargarCocinero();
        }

        async function cambiarEstado(pedidoId, estado) {
            await fetch(`${API}/pedidos/${pedidoId}/estado`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado })
            });
            cargarChef();
        }

        async function cargarGeneral() {
            await cargarDatos();

            document.getElementById('todasMesas').innerHTML = mesas.map(m => {
                const ocupada = m.mozo_id ? 'ocupada' : '';
                return `<div class="mesa-card ${ocupada}">
                    <div><strong>Mesa ${m.numero}</strong></div>
                    <div>Cap: ${m.capacidad}</div>
                    ${m.mozo_nombre ? `<div>Mozo: ${m.mozo_nombre}</div>` : '<div>Disponible</div>'}
                </div>`;
            }).join('');

            let html = '';
            for (let p of pedidos.filter(p => p.estado !== 'pagado')) {
                const items = await fetch(`${API}/pedidos/${p.id}/items`).then(r => r.json());
                html += `<div class="pedido-card">
                    <strong>Pedido #${p.id} - Mesa ${p.mesa_numero} - ${p.mozo_nombre}</strong>
                    <span class="estado ${p.estado}">${p.estado}</span>
                    <div>${items.map(i => `${i.nombre} x${i.cantidad}`).join(', ')}</div>
                    <div>Total: $${p.total}</div>
                </div>`;
            }
            document.getElementById('todasOrdenes').innerHTML = html || '<p>No hay √≥rdenes activas</p>';
        }

        cargarDatos();
    </script>
</body>

</html>